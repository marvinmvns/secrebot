@echo off
REM =============================================================================
REM üöÄ SecreBot - Instalador Autom√°tico para Windows
REM =============================================================================
REM Assistente Inteligente para WhatsApp com IA Avan√ßada
REM Este script instala automaticamente todas as depend√™ncias necess√°rias
REM Suporte: Windows 10/11, Windows Server 2019/2022
REM =============================================================================

setlocal enabledelayedexpansion
title SecreBot - Instalador Autom√°tico v2.0.0

REM =============================================================================
REM üîß CONFIGURA√á√ïES GLOBAIS
REM =============================================================================
set "SCRIPT_VERSION=2.0.0"
set "LOG_FILE=%TEMP%\secrebot-install-%DATE:~-4,4%%DATE:~-10,2%%DATE:~-7,2%_%TIME:~0,2%%TIME:~3,2%%TIME:~6,2%.log"
set "INSTALL_DIR=%USERPROFILE%\secrebot"
set "MONGO_DB_NAME=sched"
set "MONGO_USER=bot"

REM Gerar senha aleat√≥ria
for /f %%i in ('powershell -Command "[System.Web.Security.Membership]::GeneratePassword(32, 0)"') do set "MONGO_PASSWORD=%%i"

REM Cores ANSI para output
set "RED=[91m"
set "GREEN=[92m"
set "YELLOW=[93m"
set "BLUE=[94m"
set "PURPLE=[95m"
set "CYAN=[96m"
set "NC=[0m"

REM =============================================================================
REM üõ†Ô∏è FUN√á√ïES DE UTILIDADE
REM =============================================================================

:log_info
echo %GREEN%[INFO]%NC% %~1 >> "%LOG_FILE%"
echo %GREEN%[INFO]%NC% %~1
goto :eof

:log_warn
echo %YELLOW%[WARN]%NC% %~1 >> "%LOG_FILE%"
echo %YELLOW%[WARN]%NC% %~1
goto :eof

:log_error
echo %RED%[ERROR]%NC% %~1 >> "%LOG_FILE%"
echo %RED%[ERROR]%NC% %~1
goto :eof

:log_debug
echo %BLUE%[DEBUG]%NC% %~1 >> "%LOG_FILE%"
echo %BLUE%[DEBUG]%NC% %~1
goto :eof

:log_step
echo.
echo %PURPLE%[STEP]%NC% %~1 >> "%LOG_FILE%"
echo %PURPLE%[STEP]%NC% %~1
echo ==========================================
echo ========================================== >> "%LOG_FILE%"
goto :eof

:check_command
where %1 >nul 2>&1
if errorlevel 1 (
    exit /b 1
) else (
    exit /b 0
)

:check_service
sc query "%1" | find "RUNNING" >nul 2>&1
if errorlevel 1 (
    exit /b 1
) else (
    exit /b 0
)

:check_internet
ping -n 1 google.com >nul 2>&1
if errorlevel 1 (
    exit /b 1
) else (
    exit /b 0
)

:check_admin
net session >nul 2>&1
if errorlevel 1 (
    exit /b 1
) else (
    exit /b 0
)

:get_system_info
for /f "tokens=2 delims==" %%i in ('wmic os get caption /value ^| find "="') do set "OS_NAME=%%i"
for /f "tokens=2 delims==" %%i in ('wmic os get version /value ^| find "="') do set "OS_VERSION=%%i"
for /f "tokens=2 delims==" %%i in ('wmic computersystem get SystemType /value ^| find "="') do set "ARCH=%%i"
goto :eof

:check_disk_space
for /f "tokens=3" %%i in ('dir /-c %USERPROFILE% ^| find "bytes free"') do (
    set /a "FREE_GB=%%i/1024/1024/1024"
)
if !FREE_GB! LSS 5 (
    call :log_error "Espa√ßo insuficiente em disco. Necess√°rio: 5GB, Dispon√≠vel: !FREE_GB!GB"
    exit /b 1
)
call :log_info "Espa√ßo em disco: !FREE_GB!GB dispon√≠vel"
goto :eof

:check_memory
for /f "skip=1 tokens=2" %%i in ('wmic computersystem get TotalPhysicalMemory ^| find /v ""') do (
    set /a "TOTAL_RAM_GB=%%i/1024/1024/1024"
)
if !TOTAL_RAM_GB! LSS 4 (
    call :log_warn "Mem√≥ria RAM baixa: !TOTAL_RAM_GB!GB (recomendado: 4GB+)"
) else (
    call :log_info "Mem√≥ria RAM: !TOTAL_RAM_GB!GB"
)
goto :eof

REM =============================================================================
REM üîí VERIFICA√á√ïES PRELIMINARES
REM =============================================================================

:check_requirements
call :log_step "Verificando requisitos do sistema"

REM Verificar se est√° rodando como administrador
call :check_admin
if errorlevel 1 (
    call :log_error "Execute como Administrador"
    call :log_info "Clique com bot√£o direito no script e selecione 'Executar como administrador'"
    pause
    exit /b 1
)

REM Verificar conex√£o internet
call :check_internet
if errorlevel 1 (
    call :log_error "Sem conex√£o com internet"
    call :log_info "Verifique sua conex√£o e tente novamente"
    pause
    exit /b 1
)

call :check_disk_space
if errorlevel 1 (
    pause
    exit /b 1
)

call :check_memory

REM Obter informa√ß√µes do sistema
call :get_system_info
call :log_info "Sistema: !OS_NAME! (!OS_VERSION!)"
call :log_info "Arquitetura: !ARCH!"

REM Verificar vers√£o do Windows
echo !OS_VERSION! | findstr /r "^10\." >nul
if not errorlevel 1 (
    call :log_info "Windows 10 detectado"
    goto :version_ok
)

echo !OS_VERSION! | findstr /r "^6\." >nul
if not errorlevel 1 (
    call :log_warn "Windows 7/8 detectado - algumas funcionalidades podem n√£o funcionar"
    goto :version_ok
)

call :log_info "Vers√£o do Windows suportada"

:version_ok
call :log_info "Verifica√ß√µes preliminares conclu√≠das"
goto :eof

REM =============================================================================
REM üì¶ INSTALA√á√ÉO DO CHOCOLATEY
REM =============================================================================

:install_chocolatey
call :log_step "Instalando Chocolatey Package Manager"

call :check_command choco
if not errorlevel 1 (
    call :log_info "Chocolatey j√° est√° instalado"
    goto :eof
)

call :log_info "Baixando e instalando Chocolatey..."

powershell -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))"

if errorlevel 1 (
    call :log_error "Falha na instala√ß√£o do Chocolatey"
    exit /b 1
)

REM Atualizar PATH
call refreshenv
set "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"

call :check_command choco
if errorlevel 1 (
    call :log_error "Chocolatey n√£o foi instalado corretamente"
    call :log_info "Reinicie o prompt como administrador e tente novamente"
    exit /b 1
)

call :log_info "Chocolatey instalado com sucesso"
goto :eof

REM =============================================================================
REM üì¶ INSTALA√á√ÉO DE DEPEND√äNCIAS DO SISTEMA
REM =============================================================================

:install_system_deps
call :log_step "Instalando depend√™ncias do sistema"

call :log_info "Instalando depend√™ncias b√°sicas via Chocolatey..."

REM Instalar Node.js
call :check_command node
if errorlevel 1 (
    call :log_info "Instalando Node.js..."
    choco install nodejs --version=18.20.4 -y
    if errorlevel 1 (
        call :log_error "Falha na instala√ß√£o do Node.js"
        exit /b 1
    )
) else (
    for /f "tokens=1" %%v in ('node --version') do (
        set "NODE_VERSION=%%v"
        set "NODE_MAJOR=!NODE_VERSION:~1,2!"
    )
    if !NODE_MAJOR! LSS 18 (
        call :log_info "Atualizando Node.js para vers√£o 18..."
        choco upgrade nodejs --version=18.20.4 -y
    ) else (
        call :log_info "Node.js j√° est√° instalado"
    )
)

REM Instalar Python
call :check_command python
if errorlevel 1 (
    call :log_info "Instalando Python..."
    choco install python3 -y
    if errorlevel 1 (
        call :log_error "Falha na instala√ß√£o do Python"
        exit /b 1
    )
)

REM Instalar Git
call :check_command git
if errorlevel 1 (
    call :log_info "Instalando Git..."
    choco install git -y
    if errorlevel 1 (
        call :log_error "Falha na instala√ß√£o do Git"
        exit /b 1
    )
)

REM Instalar FFmpeg
call :check_command ffmpeg
if errorlevel 1 (
    call :log_info "Instalando FFmpeg..."
    choco install ffmpeg -y
    if errorlevel 1 (
        call :log_error "Falha na instala√ß√£o do FFmpeg"
        exit /b 1
    )
)

REM Instalar MongoDB
call :check_command mongod
if errorlevel 1 (
    call :log_info "Instalando MongoDB..."
    choco install mongodb -y
    if errorlevel 1 (
        call :log_error "Falha na instala√ß√£o do MongoDB"
        exit /b 1
    )
)

REM Instalar utilit√°rios
call :log_info "Instalando utilit√°rios adicionais..."
choco install curl wget 7zip -y

REM Atualizar PATH
call refreshenv

REM Verificar instala√ß√µes
call :log_info "Verificando instala√ß√µes..."

call :check_command node
if errorlevel 1 (
    call :log_error "Node.js n√£o foi instalado corretamente"
    exit /b 1
)

for /f "tokens=1" %%v in ('node --version') do (
    call :log_info "Node.js %%v ‚úì"
)

call :check_command npm
if errorlevel 1 (
    call :log_error "npm n√£o foi instalado corretamente"
    exit /b 1
)

for /f "tokens=1" %%v in ('npm --version') do (
    call :log_info "npm v%%v ‚úì"
)

call :check_command python
if errorlevel 1 (
    call :log_error "Python n√£o foi instalado corretamente"
    exit /b 1
)

for /f "tokens=2" %%v in ('python --version') do (
    call :log_info "Python %%v ‚úì"
)

call :check_command git
if errorlevel 1 (
    call :log_error "Git n√£o foi instalado corretamente"
    exit /b 1
)

for /f "tokens=3" %%v in ('git --version') do (
    call :log_info "Git %%v ‚úì"
)

call :check_command ffmpeg
if errorlevel 1 (
    call :log_error "FFmpeg n√£o foi instalado corretamente"
    exit /b 1
)

call :log_info "FFmpeg ‚úì"

call :log_info "Depend√™ncias do sistema instaladas com sucesso"
goto :eof

REM =============================================================================
REM üóÑÔ∏è CONFIGURA√á√ÉO DO MONGODB
REM =============================================================================

:setup_mongodb
call :log_step "Configurando MongoDB"

REM Verificar se servi√ßo MongoDB existe
sc query MongoDB >nul 2>&1
if errorlevel 1 (
    call :log_info "Configurando MongoDB como servi√ßo..."
    
    REM Criar diret√≥rio de dados
    if not exist "C:\data\db" mkdir "C:\data\db"
    
    REM Instalar servi√ßo MongoDB
    mongod --install --serviceName MongoDB --serviceDisplayName "MongoDB" --logpath "C:\data\db\mongodb.log" --dbpath "C:\data\db"
    
    if errorlevel 1 (
        call :log_error "Falha ao instalar servi√ßo MongoDB"
        exit /b 1
    )
)

REM Iniciar servi√ßo MongoDB
call :log_info "Iniciando servi√ßo MongoDB..."
net start MongoDB
if errorlevel 1 (
    sc start MongoDB
    if errorlevel 1 (
        call :log_error "Falha ao iniciar MongoDB"
        exit /b 1
    )
)

REM Aguardar MongoDB inicializar
call :log_info "Aguardando MongoDB inicializar..."
timeout /t 10 /nobreak >nul

REM Verificar se MongoDB est√° rodando
call :check_service MongoDB
if errorlevel 1 (
    call :log_error "MongoDB n√£o est√° rodando"
    exit /b 1
)

call :log_info "MongoDB iniciado com sucesso"

REM Criar usu√°rio do banco
call :log_info "Criando usu√°rio do banco de dados..."

REM Preparar script MongoDB
echo use %MONGO_DB_NAME% > "%TEMP%\mongo_setup.js"
echo db.createUser({user: "%MONGO_USER%", pwd: "%MONGO_PASSWORD%", roles: ["readWrite"]}) >> "%TEMP%\mongo_setup.js"

REM Executar script
call :check_command mongosh
if not errorlevel 1 (
    mongosh < "%TEMP%\mongo_setup.js"
) else (
    call :check_command mongo
    if not errorlevel 1 (
        mongo < "%TEMP%\mongo_setup.js"
    ) else (
        call :log_error "Cliente MongoDB n√£o encontrado"
        exit /b 1
    )
)

if errorlevel 1 (
    call :log_warn "Falha ao criar usu√°rio (pode j√° existir)"
) else (
    call :log_info "Usu√°rio MongoDB criado: %MONGO_USER%"
)

REM Limpar arquivo tempor√°rio
del "%TEMP%\mongo_setup.js" 2>nul

REM Testar conex√£o
call :log_info "Testando conex√£o MongoDB..."
set "MONGO_URI=mongodb://%MONGO_USER%:%MONGO_PASSWORD%@localhost:27017/%MONGO_DB_NAME%?authSource=%MONGO_DB_NAME%"

if exist "%PROGRAMFILES%\MongoDB\Server\*\bin\mongosh.exe" (
    "%PROGRAMFILES%\MongoDB\Server\*\bin\mongosh.exe" "%MONGO_URI%" --eval "db.runCommand({ping: 1})" >nul 2>&1
) else (
    mongosh "%MONGO_URI%" --eval "db.runCommand({ping: 1})" >nul 2>&1
)

if errorlevel 1 (
    call :log_error "Falha ao conectar ao MongoDB com credenciais"
    exit /b 1
)

call :log_info "MongoDB configurado com sucesso ‚úì"
goto :eof

REM =============================================================================
REM ü§ñ INSTALA√á√ÉO DO OLLAMA
REM =============================================================================

:install_ollama
call :log_step "Instalando Ollama"

call :check_command ollama
if not errorlevel 1 (
    call :log_info "Ollama j√° est√° instalado"
    goto :download_models
)

call :log_info "Baixando Ollama para Windows..."

REM Baixar instalador do Ollama
powershell -Command "Invoke-WebRequest -Uri 'https://ollama.com/download/OllamaSetup.exe' -OutFile '%TEMP%\OllamaSetup.exe'"

if errorlevel 1 (
    call :log_error "Falha ao baixar Ollama"
    exit /b 1
)

call :log_info "Instalando Ollama..."
start /wait "%TEMP%\OllamaSetup.exe" /S

if errorlevel 1 (
    call :log_error "Falha na instala√ß√£o do Ollama"
    exit /b 1
)

REM Atualizar PATH
call refreshenv

call :check_command ollama
if errorlevel 1 (
    call :log_error "Ollama n√£o foi instalado corretamente"
    call :log_info "Reinicie o sistema e tente novamente"
    exit /b 1
)

call :log_info "Ollama instalado com sucesso"

:download_models
REM Iniciar Ollama
call :log_info "Iniciando Ollama..."
start /min ollama serve

REM Aguardar Ollama inicializar
call :log_info "Aguardando Ollama inicializar..."
timeout /t 15 /nobreak >nul

REM Verificar se Ollama est√° acess√≠vel
for /l %%i in (1,1,30) do (
    curl -s http://127.0.0.1:11434/api/tags >nul 2>&1
    if not errorlevel 1 (
        call :log_info "Ollama API dispon√≠vel"
        goto :models_download
    )
    timeout /t 2 /nobreak >nul
)

call :log_error "Ollama falhou ao inicializar"
exit /b 1

:models_download
REM Baixar modelos essenciais
call :log_info "Baixando modelos de IA..."

call :log_info "Baixando llama3.2:latest (modelo de texto)..."
ollama pull llama3.2:latest
if errorlevel 1 (
    call :log_error "Falha ao baixar modelo llama3.2"
    exit /b 1
)

call :log_info "Baixando llava:latest (modelo de imagem)..."
ollama pull llava:latest
if errorlevel 1 (
    call :log_error "Falha ao baixar modelo llava"
    exit /b 1
)

REM Listar modelos instalados
call :log_info "Modelos instalados:"
ollama list

call :log_info "Ollama configurado com sucesso ‚úì"
goto :eof

REM =============================================================================
REM üì± CONFIGURA√á√ÉO DO PROJETO SECREBOT
REM =============================================================================

:setup_project
call :log_step "Configurando projeto SecreBot"

REM Remover instala√ß√£o existente se houver
if exist "%INSTALL_DIR%" (
    call :log_warn "Diret√≥rio existente encontrado: %INSTALL_DIR%"
    set /p "REPLY=Deseja sobrescrever? (s/N): "
    if /i "!REPLY!"=="s" (
        call :log_info "Removendo instala√ß√£o anterior..."
        rmdir /s /q "%INSTALL_DIR%"
    ) else (
        call :log_error "Instala√ß√£o cancelada pelo usu√°rio"
        exit /b 1
    )
)

REM Clonar projeto
call :log_info "Clonando projeto SecreBot..."

REM Verificar se SECREBOT_REPO est√° definido
if defined SECREBOT_REPO (
    git clone "%SECREBOT_REPO%" "%INSTALL_DIR%"
) else (
    REM Se estamos executando dentro do diret√≥rio do projeto
    if exist "%~dp0package.json" (
        call :log_info "Copiando projeto atual..."
        xcopy "%~dp0*" "%INSTALL_DIR%\" /E /I /H /Y
    ) else (
        call :log_error "URL do reposit√≥rio n√£o fornecida e package.json n√£o encontrado"
        call :log_info "Defina a vari√°vel SECREBOT_REPO ou execute dentro do diret√≥rio do projeto"
        exit /b 1
    )
)

if errorlevel 1 (
    call :log_error "Falha ao clonar/copiar projeto"
    exit /b 1
)

cd /d "%INSTALL_DIR%"

REM Verificar se √© um projeto SecreBot v√°lido
if not exist "package.json" (
    call :log_error "Projeto SecreBot inv√°lido (package.json n√£o encontrado)"
    exit /b 1
)

findstr /i "whatsapp" package.json >nul
if errorlevel 1 (
    call :log_error "Projeto SecreBot inv√°lido (n√£o cont√©m depend√™ncias WhatsApp)"
    exit /b 1
)

call :log_info "Projeto clonado com sucesso"

REM Instalar depend√™ncias NPM
call :log_info "Instalando depend√™ncias NPM..."
npm install
if errorlevel 1 (
    call :log_error "Falha na instala√ß√£o das depend√™ncias NPM"
    exit /b 1
)

REM Instalar Playwright
call :log_info "Instalando navegadores Playwright..."
npx playwright install
if errorlevel 1 (
    call :log_warn "Falha na instala√ß√£o do Playwright (n√£o cr√≠tico)"
)

REM Configurar Whisper
call :log_info "Configurando Whisper para transcri√ß√£o de √°udio..."
call :check_command python
if errorlevel 1 (
    call :log_error "Python necess√°rio para Whisper"
    exit /b 1
)

REM Instalar depend√™ncias NPM para Whisper
call :log_info "Instalando nodejs-whisper e depend√™ncias..."
npm install --save nodejs-whisper
if errorlevel 1 (
    call :log_warn "Falha na instala√ß√£o do nodejs-whisper (n√£o cr√≠tico)"
) else (
    call :log_info "nodejs-whisper instalado com sucesso"
)

REM Verificar se FFmpeg est√° dispon√≠vel
call :check_command ffmpeg
if errorlevel 1 (
    call :log_error "FFmpeg necess√°rio para Whisper"
    exit /b 1
)

call :log_info "Whisper configurado com sucesso ‚úì"

REM Criar arquivo .env
call :log_info "Configurando arquivo .env..."
if exist ".env.example" (
    copy ".env.example" ".env" >nul
    
    REM Configurar MongoDB no .env
    powershell -Command "(Get-Content .env) -replace 'mongodb://bot:sua_senha@localhost:27017/sched\?authSource=sched', 'mongodb://%MONGO_USER%:%MONGO_PASSWORD%@localhost:27017/%MONGO_DB_NAME%?authSource=%MONGO_DB_NAME%' | Set-Content .env"
    
    REM Configurar Piper como padr√£o (ser√° configurado automaticamente pela fun√ß√£o install_piper)
    powershell -Command "(Get-Content .env) -replace '^# PIPER_ENABLED=.*', 'PIPER_ENABLED=true' | Set-Content .env"
    powershell -Command "(Get-Content .env) -replace '^# PIPER_EXECUTABLE=.*', 'PIPER_EXECUTABLE=./piper/piper-wrapper.bat' | Set-Content .env"
    powershell -Command "(Get-Content .env) -replace '^# PIPER_MODEL=.*', 'PIPER_MODEL=./piper/models/pt_BR-cadu-medium.onnx' | Set-Content .env"
    
    call :log_info "Arquivo .env configurado"
) else (
    call :log_error "Arquivo .env.example n√£o encontrado"
    exit /b 1
)

call :log_info "Projeto SecreBot configurado com sucesso ‚úì"
goto :eof

REM =============================================================================
REM üé§ INSTALA√á√ÉO DO PIPER TTS
REM =============================================================================

:install_piper
call :log_step "Instalando Piper TTS"

cd /d "%INSTALL_DIR%"

REM Criar diret√≥rio do Piper
call :log_info "Criando diret√≥rio do Piper..."
if not exist "piper" mkdir piper
if not exist "piper\models" mkdir piper\models

REM Detectar arquitetura
set "PIPER_ARCH=amd64"
if "%PROCESSOR_ARCHITECTURE%"=="ARM64" set "PIPER_ARCH=arm64"

REM URLs dos arquivos
set "PIPER_VERSION=1.2.0"
set "PIPER_URL=https://github.com/rhasspy/piper/releases/download/v%PIPER_VERSION%/piper_windows_%PIPER_ARCH%.zip"
set "CADU_VOICE_URL=https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/pt/pt_BR/cadu/medium/pt_BR-cadu-medium.onnx"
set "CADU_CONFIG_URL=https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/pt/pt_BR/cadu/medium/pt_BR-cadu-medium.onnx.json"

REM Baixar bin√°rio do Piper
call :log_info "Baixando Piper %PIPER_VERSION% para %PIPER_ARCH%..."
powershell -Command "try { Invoke-WebRequest -Uri '%PIPER_URL%' -OutFile '%TEMP%\piper_windows.zip' -UseBasicParsing } catch { exit 1 }"
if errorlevel 1 (
    call :log_error "Falha ao baixar Piper"
    powershell -Command "(Get-Content .env) -replace 'PIPER_ENABLED=true', 'PIPER_ENABLED=false' | Set-Content .env"
    goto :eof
)

REM Extrair Piper
call :log_info "Extraindo Piper..."
powershell -Command "try { Expand-Archive -Path '%TEMP%\piper_windows.zip' -DestinationPath 'piper' -Force } catch { exit 1 }"
if errorlevel 1 (
    call :log_error "Falha ao extrair Piper"
    powershell -Command "(Get-Content .env) -replace 'PIPER_ENABLED=true', 'PIPER_ENABLED=false' | Set-Content .env"
    goto :eof
)

REM Baixar voz Cadu (portugu√™s brasileiro)
call :log_info "Baixando voz Cadu (portugu√™s brasileiro)..."
powershell -Command "try { Invoke-WebRequest -Uri '%CADU_VOICE_URL%' -OutFile 'piper\models\pt_BR-cadu-medium.onnx' -UseBasicParsing } catch { exit 1 }"
if errorlevel 1 (
    call :log_error "Falha ao baixar voz Cadu"
    powershell -Command "(Get-Content .env) -replace 'PIPER_ENABLED=true', 'PIPER_ENABLED=false' | Set-Content .env"
    goto :eof
)

REM Baixar arquivo de configura√ß√£o da voz Cadu
call :log_info "Baixando configura√ß√£o da voz Cadu..."
powershell -Command "try { Invoke-WebRequest -Uri '%CADU_CONFIG_URL%' -OutFile 'piper\models\pt_BR-cadu-medium.onnx.json' -UseBasicParsing } catch { exit 1 }"
if errorlevel 1 (
    call :log_error "Falha ao baixar configura√ß√£o da voz Cadu"
    powershell -Command "(Get-Content .env) -replace 'PIPER_ENABLED=true', 'PIPER_ENABLED=false' | Set-Content .env"
    goto :eof
)

REM Criar script wrapper para facilitar uso
call :log_info "Criando script wrapper do Piper..."
echo @echo off > piper\piper-wrapper.bat
echo REM Wrapper para Piper TTS - SecreBot >> piper\piper-wrapper.bat
echo set "SCRIPT_DIR=%%~dp0" >> piper\piper-wrapper.bat
echo set "PIPER_BIN=%%SCRIPT_DIR%%piper.exe" >> piper\piper-wrapper.bat
echo set "DEFAULT_MODEL=%%SCRIPT_DIR%%models\pt_BR-cadu-medium.onnx" >> piper\piper-wrapper.bat
echo. >> piper\piper-wrapper.bat
echo REM Verificar se o bin√°rio existe >> piper\piper-wrapper.bat
echo if not exist "%%PIPER_BIN%%" ( >> piper\piper-wrapper.bat
echo     echo Erro: Bin√°rio do Piper n√£o encontrado em %%PIPER_BIN%% ^>^&2 >> piper\piper-wrapper.bat
echo     exit /b 1 >> piper\piper-wrapper.bat
echo ^) >> piper\piper-wrapper.bat
echo. >> piper\piper-wrapper.bat
echo REM Verificar se o modelo existe >> piper\piper-wrapper.bat
echo if not exist "%%DEFAULT_MODEL%%" ( >> piper\piper-wrapper.bat
echo     echo Erro: Modelo da voz n√£o encontrado em %%DEFAULT_MODEL%% ^>^&2 >> piper\piper-wrapper.bat
echo     exit /b 1 >> piper\piper-wrapper.bat
echo ^) >> piper\piper-wrapper.bat
echo. >> piper\piper-wrapper.bat
echo REM Executar Piper com modelo padr√£o se n√£o especificado >> piper\piper-wrapper.bat
echo echo %%* ^| findstr /C:"--model" ^>nul >> piper\piper-wrapper.bat
echo if errorlevel 1 ( >> piper\piper-wrapper.bat
echo     "%%PIPER_BIN%%" --model "%%DEFAULT_MODEL%%" %%* >> piper\piper-wrapper.bat
echo ^) else ( >> piper\piper-wrapper.bat
echo     "%%PIPER_BIN%%" %%* >> piper\piper-wrapper.bat
echo ^) >> piper\piper-wrapper.bat

REM Testar instala√ß√£o do Piper
call :log_info "Testando instala√ß√£o do Piper..."
echo Teste do Piper TTS | piper\piper-wrapper.bat --output_file "%TEMP%\piper_test.wav" >nul 2>&1
if not errorlevel 1 (
    call :log_info "Piper TTS instalado e testado com sucesso ‚úì"
    del "%TEMP%\piper_test.wav" 2>nul
    
    REM Configurar .env para usar Piper
    powershell -Command "(Get-Content .env) -replace '^# PIPER_ENABLED=.*', 'PIPER_ENABLED=true' | Set-Content .env"
    powershell -Command "(Get-Content .env) -replace '^# PIPER_EXECUTABLE=.*', 'PIPER_EXECUTABLE=./piper/piper-wrapper.bat' | Set-Content .env"
    powershell -Command "(Get-Content .env) -replace '^# PIPER_MODEL=.*', 'PIPER_MODEL=./piper/models/pt_BR-cadu-medium.onnx' | Set-Content .env"
    
) else (
    call :log_warn "Falha no teste do Piper (desabilitando TTS)"
    powershell -Command "(Get-Content .env) -replace 'PIPER_ENABLED=true', 'PIPER_ENABLED=false' | Set-Content .env"
)

REM Limpar arquivo tempor√°rio
del "%TEMP%\piper_windows.zip" 2>nul

call :log_info "Instala√ß√£o do Piper conclu√≠da"
goto :eof

REM =============================================================================
REM ‚úÖ VALIDA√á√ÉO DA INSTALA√á√ÉO
REM =============================================================================

:validate_installation
call :log_step "Validando instala√ß√£o"

cd /d "%INSTALL_DIR%"

REM Verificar servi√ßos
call :log_info "Verificando servi√ßos..."

call :check_service MongoDB
if errorlevel 1 (
    call :log_error "MongoDB n√£o est√° rodando"
    exit /b 1
)
call :log_info "MongoDB: ‚úì Rodando"

curl -s http://127.0.0.1:11434/api/tags >nul 2>&1
if errorlevel 1 (
    call :log_error "Ollama n√£o est√° acess√≠vel"
    exit /b 1
)
call :log_info "Ollama: ‚úì Acess√≠vel"

REM Verificar depend√™ncias Node.js
call :log_info "Verificando depend√™ncias Node.js..."
npm list >nul 2>&1
if errorlevel 1 (
    call :log_error "Depend√™ncias Node.js n√£o instaladas corretamente"
    exit /b 1
)
call :log_info "Depend√™ncias NPM: ‚úì Instaladas"

REM Verificar arquivo .env
if not exist ".env" (
    call :log_error "Arquivo .env n√£o encontrado"
    exit /b 1
)
call :log_info "Configura√ß√£o: ‚úì .env presente"

REM Teste de conectividade MongoDB
call :log_info "Testando conectividade MongoDB..."
set "MONGO_URI=mongodb://%MONGO_USER%:%MONGO_PASSWORD%@localhost:27017/%MONGO_DB_NAME%?authSource=%MONGO_DB_NAME%"

call :check_command mongosh
if not errorlevel 1 (
    mongosh "%MONGO_URI%" --eval "db.runCommand({ping: 1})" >nul 2>&1
) else (
    mongo "%MONGO_URI%" --eval "db.runCommand({ping: 1})" >nul 2>&1
)

if errorlevel 1 (
    call :log_error "Falha na conectividade MongoDB"
    exit /b 1
)
call :log_info "MongoDB: ‚úì Conectividade OK"

REM Teste b√°sico do projeto (se houver testes)
npm run | findstr "test" >nul 2>&1
if not errorlevel 1 (
    call :log_info "Executando testes do projeto..."
    npm test
    if errorlevel 1 (
        call :log_warn "Alguns testes falharam (n√£o cr√≠tico)"
    ) else (
        call :log_info "Testes: ‚úì Passou"
    )
)

call :log_info "Valida√ß√£o conclu√≠da com sucesso ‚úì"
goto :eof

REM =============================================================================
REM üßπ LIMPEZA E TRATAMENTO DE ERROS
REM =============================================================================

:cleanup_on_error
call :log_error "Limpando ap√≥s erro..."

REM Remover arquivos tempor√°rios
del "%TEMP%\mongo_setup.js" 2>nul
del "%TEMP%\OllamaSetup.exe" 2>nul

call :log_info "Log completo dispon√≠vel em: %LOG_FILE%"
goto :eof

:handle_error
call :log_error "Erro durante a instala√ß√£o"
call :log_info "C√≥digo de erro: %ERRORLEVEL%"

REM Sugest√µes baseadas no c√≥digo de erro
if %ERRORLEVEL%==1 (
    call :log_info "üí° Solu√ß√£o: Verifique as permiss√µes e conex√£o de internet"
) else if %ERRORLEVEL%==2 (
    call :log_info "üí° Solu√ß√£o: Verifique se todos os argumentos foram fornecidos"
) else if %ERRORLEVEL%==5 (
    call :log_info "üí° Solu√ß√£o: Execute como Administrador"
) else (
    call :log_info "üí° Consulte o log completo: %LOG_FILE%"
)

call :cleanup_on_error
pause
exit /b %ERRORLEVEL%

REM =============================================================================
REM üìä RELAT√ìRIO FINAL
REM =============================================================================

:show_final_report
call :log_step "Relat√≥rio de Instala√ß√£o"

echo.
echo %GREEN%üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO! üéâ%NC%
echo.

echo %CYAN%üìã RESUMO DA INSTALA√á√ÉO:%NC%
echo   ü™ü Sistema: !OS_NAME! (!OS_VERSION!)
for /f "tokens=1" %%v in ('node --version') do echo   üì¶ Node.js: %%v
echo   üóÑÔ∏è MongoDB: Configurado com usu√°rio '%MONGO_USER%'
for /f "tokens=1" %%c in ('ollama list ^| find /c /v ""') do echo   ü§ñ Ollama: %%c modelos instalados
echo   üì± SecreBot: Instalado em %INSTALL_DIR%
if exist "%INSTALL_DIR%\piper\piper.exe" (
    echo   üé§ Piper TTS: Instalado com voz Cadu
) else (
    echo   üé§ Piper TTS: Falha na instala√ß√£o
)

echo.
echo %CYAN%üöÄ PR√ìXIMOS PASSOS:%NC%
echo   1. cd /d "%INSTALL_DIR%"
echo   2. npm start
echo   3. Escaneie o QR Code com seu WhatsApp
echo   4. Envie uma mensagem para testar

echo.
echo %CYAN%üåê INTERFACES DISPON√çVEIS:%NC%
echo   ‚Ä¢ WhatsApp Bot: Ativo ap√≥s escanear QR Code
echo   ‚Ä¢ Interface Web: http://localhost:3000
echo   ‚Ä¢ API REST: http://localhost:3000/api

echo.
echo %CYAN%üìñ COMANDOS √öTEIS:%NC%
echo   ‚Ä¢ Iniciar: npm start
echo   ‚Ä¢ Parar: Ctrl+C
echo   ‚Ä¢ Status MongoDB: sc query MongoDB
echo   ‚Ä¢ Status Ollama: tasklist ^| findstr ollama

echo.
echo %CYAN%üÜò SUPORTE:%NC%
echo   ‚Ä¢ Documenta√ß√£o: %INSTALL_DIR%\README.md
echo   ‚Ä¢ Log de instala√ß√£o: %LOG_FILE%
echo   ‚Ä¢ Configura√ß√£o: %INSTALL_DIR%\.env

echo.
echo %GREEN%Instala√ß√£o realizada em: %DATE% %TIME%%NC%
echo.
goto :eof

REM =============================================================================
REM üéØ EXECU√á√ÉO PRINCIPAL
REM =============================================================================

:main
REM Exibir cabe√ßalho
cls
echo %PURPLE%=============================================================================%NC%
echo %PURPLE%üöÄ SecreBot - Instalador Autom√°tico para Windows v%SCRIPT_VERSION%%NC%
echo %PURPLE%=============================================================================%NC%
echo %CYAN%Assistente Inteligente para WhatsApp com IA Avan√ßada%NC%
echo %CYAN%Este script ir√° instalar automaticamente todas as depend√™ncias necess√°rias%NC%
echo %PURPLE%=============================================================================%NC%
echo.

REM Inicializar log
echo SecreBot Installation Log - %DATE% %TIME% > "%LOG_FILE%"
echo Script Version: %SCRIPT_VERSION% >> "%LOG_FILE%"
echo ======================================== >> "%LOG_FILE%"

call :log_info "Iniciando instala√ß√£o do SecreBot v%SCRIPT_VERSION%"
call :log_info "Log: %LOG_FILE%"

REM Executar etapas
call :check_requirements
if errorlevel 1 goto :handle_error

call :install_chocolatey
if errorlevel 1 goto :handle_error

call :install_system_deps
if errorlevel 1 goto :handle_error

call :setup_mongodb
if errorlevel 1 goto :handle_error

call :install_ollama
if errorlevel 1 goto :handle_error

call :setup_project
if errorlevel 1 goto :handle_error

call :install_piper
if errorlevel 1 goto :handle_error

call :validate_installation
if errorlevel 1 goto :handle_error

REM Relat√≥rio final
call :show_final_report

call :log_info "üéâ Instala√ß√£o conclu√≠da com sucesso!"
goto :end

:end
echo.
echo %GREEN%SecreBot est√° pronto para uso!%NC%
echo %YELLOW%Pressione qualquer tecla para continuar...%NC%
pause >nul
exit /b 0