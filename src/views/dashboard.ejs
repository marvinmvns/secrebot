<!-- Sistema e Hardware -->
<div class="row mb-4">
  <div class="col-12">
    <h2><i class="fas fa-server text-primary"></i> Monitoramento do Sistema</h2>
    <div class="row">
      <!-- CPU Card -->
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h6 class="card-title text-muted mb-0">CPU</h6>
              <i class="fas fa-microchip text-primary fa-lg"></i>
            </div>
            <div class="mb-3">
              <div class="chart-container">
                <canvas id="cpuChart" width="120" height="120"></canvas>
                <div class="chart-center-text">
                  <h3 id="cpuUsage">--</h3>
                  <small>%</small>
                </div>
              </div>
            </div>
            <small class="text-muted" id="cpuInfo">Carregando...</small>
          </div>
        </div>
      </div>

      <!-- Memory Card -->
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h6 class="card-title text-muted mb-0">Memória</h6>
              <i class="fas fa-memory text-success fa-lg"></i>
            </div>
            <div class="mb-3">
              <div class="chart-container">
                <canvas id="memoryChart" width="120" height="120"></canvas>
                <div class="chart-center-text">
                  <h3 id="memoryUsage">--</h3>
                  <small>%</small>
                </div>
              </div>
            </div>
            <small class="text-muted" id="memoryInfo">Carregando...</small>
          </div>
        </div>
      </div>

      <!-- Whisper Endpoints Card -->
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h6 class="card-title text-muted mb-0">Whisper API</h6>
              <i class="fas fa-microphone text-warning fa-lg"></i>
            </div>
            <div class="mb-2">
              <h3 class="mb-1">
                <span id="whisperActive" class="text-success">--</span>
                /
                <span id="whisperTotal" class="text-muted">--</span>
              </h3>
              <small class="text-muted">Endpoints Ativos</small>
            </div>
            <div class="mb-2">
              <div class="d-flex justify-content-between">
                <small class="text-muted">Fila Total:</small>
                <small id="whisperQueue" class="text-info">--</small>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">Processando:</small>
                <small id="whisperProcessing" class="text-warning">--</small>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">Processados:</small>
                <small id="whisperProcessedToday" class="text-success">--</small>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">Status:</small>
                <small id="whisperHealthStatus" class="badge bg-secondary">--</small>
              </div>
            </div>
            <div class="progress" style="height: 8px;">
              <div id="whisperProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ollama Endpoints Card -->
      <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h6 class="card-title text-muted mb-0">Ollama API</h6>
              <i class="fas fa-brain text-info fa-lg"></i>
            </div>
            <div class="mb-2">
              <h3 class="mb-1">
                <span id="ollamaActive" class="text-success">--</span>
                /
                <span id="ollamaTotal" class="text-muted">--</span>
              </h3>
              <small class="text-muted">Endpoints Ativos</small>
            </div>
            <div class="mb-2">
              <div class="d-flex justify-content-between">
                <small class="text-muted">Modelos:</small>
                <small id="ollamaModels" class="text-info">--</small>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">Processando:</small>
                <small id="ollamaProcessing" class="text-warning">--</small>
              </div>
            </div>
            <div class="progress" style="height: 8px;">
              <div id="ollamaProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Informações do Sistema -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-3"><i class="fas fa-info-circle text-primary"></i> Informações do Sistema</h6>
        <div class="row">
          <div class="col-md-3">
            <small class="text-muted">Hostname:</small><br>
            <strong id="systemHostname">--</strong>
          </div>
          <div class="col-md-3">
            <small class="text-muted">Sistema:</small><br>
            <strong id="systemOS">--</strong>
          </div>
          <div class="col-md-3">
            <small class="text-muted">Uptime:</small><br>
            <strong id="systemUptime">--</strong>
          </div>
          <div class="col-md-3">
            <small class="text-muted">Última Atualização:</small><br>
            <strong id="lastUpdate">--</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estatísticas de Processamento -->
<div class="row mb-4">
  <div class="col-12">
    <h2><i class="fas fa-cogs text-info"></i> Filas de Processamento</h2>
    <div class="row">
      <!-- Whisper Processing -->
      <div class="col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="fas fa-microphone"></i> Whisper API - Filas</h6>
          </div>
          <div class="card-body">
            <!-- Resumo geral do Whisper -->
            <div id="whisperSummary" class="mb-3 p-2 bg-light rounded">
              <div class="row text-center">
                <div class="col-3">
                  <small class="text-muted d-block">Total na Fila</small>
                  <strong id="whisperTotalQueue" class="text-warning">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Processando</small>
                  <strong id="whisperTotalActive" class="text-danger">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Processados</small>
                  <strong id="whisperTotalProcessed" class="text-success">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Endpoints</small>
                  <strong id="whisperEndpointsRatio" class="text-info">--</strong>
                </div>
              </div>
            </div>
            
            <div id="whisperQueuesContainer" class="processing-queues">
              <div class="text-center py-3">
                <div class="spinner-border text-warning" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Ollama Processing -->
      <div class="col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-brain"></i> Ollama API - Processamento</h6>
          </div>
          <div class="card-body">
            <!-- Resumo geral do Ollama -->
            <div id="ollamaSummary" class="mb-3 p-2 bg-light rounded">
              <div class="row text-center">
                <div class="col-3">
                  <small class="text-muted d-block">Modelos Ativos</small>
                  <strong id="ollamaTotalModels" class="text-info">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Processando</small>
                  <strong id="ollamaTotalActive" class="text-danger">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Processados</small>
                  <strong id="ollamaTotalProcessed" class="text-success">--</strong>
                </div>
                <div class="col-3">
                  <small class="text-muted d-block">Endpoints</small>
                  <strong id="ollamaEndpointsRatio" class="text-info">--</strong>
                </div>
              </div>
            </div>
            
            <div id="ollamaQueuesContainer" class="processing-queues">
              <div class="text-center py-3">
                <div class="spinner-border text-info" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estatísticas de Agendamentos -->
<div class="row mb-4">
  <div class="col-12">
    <h2><i class="fas fa-calendar-alt text-success"></i> Estatísticas de Agendamentos</h2>
    <div class="row text-center">
      <div class="col-sm-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <i class="fas fa-list-ul text-primary fa-2x mb-2"></i>
            <h4><%= stats.total %></h4>
            <small class="text-muted">Total</small>
          </div>
        </div>
      </div>
      <div class="col-sm-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <i class="fas fa-clock text-warning fa-2x mb-2"></i>
            <h4><%= stats.pending %></h4>
            <small class="text-muted">Pendentes</small>
          </div>
        </div>
      </div>
      <div class="col-sm-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
            <h4><%= stats.sent %></h4>
            <small class="text-muted">Enviados</small>
          </div>
        </div>
      </div>
      <div class="col-sm-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
            <h4><%= stats.failed %></h4>
            <small class="text-muted">Falhos</small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-body">
        <h6 class="card-title"><i class="fas fa-calendar-day text-primary"></i> Próximos Agendamentos</h6>
        <ul class="list-group list-group-flush">
          <% if (stats.upcoming.length === 0) { %>
            <li class="list-group-item border-0 text-center py-4">
              <i class="fas fa-calendar-times text-muted fa-2x mb-2"></i><br>
              <span class="text-muted">Nenhum agendamento próximo</span>
            </li>
          <% } else { %>
            <% stats.upcoming.forEach(function(item){ %>
              <li class="list-group-item border-0 d-flex justify-content-between align-items-center">
                <div>
                  <i class="fas fa-clock text-warning me-2"></i>
                  <%= new Date(item.scheduledTime).toLocaleString('pt-BR') %>
                </div>
                <small class="text-muted"><%= item.message.substring(0, 50) %><%= item.message.length > 50 ? '...' : '' %></small>
              </li>
            <% }) %>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let cpuChart, memoryChart;

// Initialize charts
function initCharts() {
  const chartConfig = (color, data = 0) => ({
    type: 'doughnut',
    data: {
      datasets: [{
        data: [data, 100 - data],
        backgroundColor: [color, '#e9ecef'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { display: false }
      }
    }
  });

  const cpuCtx = document.getElementById('cpuChart').getContext('2d');
  cpuChart = new Chart(cpuCtx, chartConfig('#007bff'));

  const memoryCtx = document.getElementById('memoryChart').getContext('2d');
  memoryChart = new Chart(memoryCtx, chartConfig('#28a745'));
}

// Update system stats
async function updateSystemStats() {
  try {
    const response = await fetch(`${window.location.origin}/api/system/stats`);
    const data = await response.json();

    // Update CPU
    document.getElementById('cpuUsage').textContent = data.cpu.usage;
    document.getElementById('cpuInfo').textContent = `${data.cpu.cores} cores | ${data.cpu.brand}`;
    cpuChart.data.datasets[0].data = [data.cpu.usage, 100 - data.cpu.usage];
    cpuChart.update('none');

    // Update Memory
    document.getElementById('memoryUsage').textContent = data.memory.percentage;
    document.getElementById('memoryInfo').textContent = `${data.memory.used}GB / ${data.memory.total}GB`;
    memoryChart.data.datasets[0].data = [data.memory.percentage, 100 - data.memory.percentage];
    memoryChart.update('none');

    // Update Whisper endpoints
    document.getElementById('whisperActive').textContent = data.endpoints.whisper.active;
    document.getElementById('whisperTotal').textContent = data.endpoints.whisper.total;
    document.getElementById('whisperQueue').textContent = data.endpoints.whisper.processing?.totalQueue || 0;
    const whisperProcessingCount = data.endpoints.whisper.processing?.totalActiveRequests || 0;
    const whisperProcessingElement = document.getElementById('whisperProcessing');
    whisperProcessingElement.textContent = whisperProcessingCount;
    whisperProcessingElement.className = whisperProcessingCount > 0 ? 'text-danger' : 'text-success';
    
    // Set placeholder for processed today (will be updated by processing stats)
    document.getElementById('whisperProcessedToday').textContent = '--';
    
    // Update health status
    const whisperHealthPercent = data.endpoints.whisper.total > 0 ? 
      (data.endpoints.whisper.active / data.endpoints.whisper.total) * 100 : 0;
    const whisperHealthBadge = document.getElementById('whisperHealthStatus');
    if (whisperHealthPercent === 100) {
      whisperHealthBadge.textContent = 'Ótimo';
      whisperHealthBadge.className = 'badge bg-success';
    } else if (whisperHealthPercent >= 75) {
      whisperHealthBadge.textContent = 'Bom';
      whisperHealthBadge.className = 'badge bg-warning';
    } else if (whisperHealthPercent > 0) {
      whisperHealthBadge.textContent = 'Degradado';
      whisperHealthBadge.className = 'badge bg-danger';
    } else {
      whisperHealthBadge.textContent = 'Offline';
      whisperHealthBadge.className = 'badge bg-dark';
    }
    
    document.getElementById('whisperProgress').style.width = whisperHealthPercent + '%';

    // Update Ollama endpoints
    document.getElementById('ollamaActive').textContent = data.endpoints.ollama.active;
    document.getElementById('ollamaTotal').textContent = data.endpoints.ollama.total;
    document.getElementById('ollamaModels').textContent = data.endpoints.ollama.processing?.totalQueue || 0;
    document.getElementById('ollamaProcessing').textContent = data.endpoints.ollama.processing?.totalActiveRequests || 0;
    const ollamaPercent = data.endpoints.ollama.total > 0 ? 
      (data.endpoints.ollama.active / data.endpoints.ollama.total) * 100 : 0;
    document.getElementById('ollamaProgress').style.width = ollamaPercent + '%';

    // Update system info
    document.getElementById('systemHostname').textContent = data.system.hostname || '--';
    document.getElementById('systemOS').textContent = `${data.system.distro} ${data.system.release}`;
    document.getElementById('systemUptime').textContent = `${data.system.uptime}h`;
    document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString('pt-BR');

  } catch (error) {
    console.error('Erro ao atualizar estatísticas:', error);
  }
}

// Update processing queues details
async function updateProcessingQueues() {
  try {
    const response = await fetch(`${window.location.origin}/api/processing/stats`);
    const data = await response.json();

    // Update Whisper summary
    document.getElementById('whisperTotalQueue').textContent = data.whisper.totalQueue || 0;
    document.getElementById('whisperTotalActive').textContent = data.whisper.totalActiveRequests || 0;
    document.getElementById('whisperTotalProcessed').textContent = data.whisper.totalProcessedToday || 0;
    const whisperHealthy = data.whisper.queues.filter(q => q.healthy).length;
    document.getElementById('whisperEndpointsRatio').textContent = `${whisperHealthy}/${data.whisper.queues.length}`;
    
    // Update the card summary with processed count
    document.getElementById('whisperProcessedToday').textContent = data.whisper.totalProcessedToday || 0;

    // Update Ollama summary
    const ollamaRunningModels = data.ollama.queues.reduce((sum, q) => sum + (q.runningModels || 0), 0);
    document.getElementById('ollamaTotalModels').textContent = ollamaRunningModels || 0;
    document.getElementById('ollamaTotalActive').textContent = data.ollama.totalActiveRequests || 0;
    document.getElementById('ollamaTotalProcessed').textContent = data.ollama.totalProcessedToday || 0;
    const ollamaHealthy = data.ollama.queues.filter(q => q.healthy).length;
    document.getElementById('ollamaEndpointsRatio').textContent = `${ollamaHealthy}/${data.ollama.queues.length}`;

    // Update Whisper queues
    const whisperContainer = document.getElementById('whisperQueuesContainer');
    if (data.whisper.queues.length === 0) {
      whisperContainer.innerHTML = '<div class="text-center text-muted py-3">Nenhum endpoint Whisper configurado</div>';
    } else {
      whisperContainer.innerHTML = data.whisper.queues.map((queue, index) => `
        <div class="queue-item p-3 mb-3 border rounded ${queue.healthy ? 'border-success bg-light' : 'border-danger bg-light'}">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h6 class="mb-1">
                <i class="fas fa-server text-primary me-2"></i>
                <strong>${queue.url}</strong>
              </h6>
              <div>
                <span class="badge ${queue.healthy ? 'bg-success' : 'bg-danger'} me-1">
                  ${queue.healthy ? 'Online' : 'Offline'}
                </span>
                <span class="badge bg-secondary">Prioridade: ${queue.priority || 'N/A'}</span>
              </div>
            </div>
            <div class="text-end">
              <div class="mb-1">
                <small class="text-muted">Fila:</small> 
                <span class="badge ${queue.queueLength > 0 ? 'bg-warning' : 'bg-info'}">${queue.queueLength}</span>
              </div>
              <div>
                <small class="text-muted">Processando:</small> 
                <span class="badge ${queue.activeRequests > 0 ? 'bg-danger' : 'bg-success'}">${queue.activeRequests}</span>
              </div>
            </div>
          </div>
          ${queue.healthy ? `
            <div class="row mt-2">
              <div class="col-md-6">
                <small class="text-muted d-block">Tempo Médio de Processamento:</small>
                <strong class="text-info">${queue.avgProcessingTime}ms</strong>
              </div>
              <div class="col-md-6">
                <small class="text-muted d-block">Total Processado Hoje:</small>
                <strong class="text-success">${queue.totalProcessed}</strong>
              </div>
            </div>
            <div class="mt-2">
              <small class="text-muted">Carga do Endpoint:</small>
              <div class="progress mt-1" style="height: 6px;">
                <div class="progress-bar ${queue.queueLength > 5 ? 'bg-danger' : queue.queueLength > 2 ? 'bg-warning' : 'bg-success'}" 
                     style="width: ${Math.min((queue.queueLength / 10) * 100, 100)}%"></div>
              </div>
            </div>
          ` : `
            <div class="alert alert-warning py-2 mt-2 mb-0">
              <small><i class="fas fa-exclamation-triangle"></i> Endpoint offline ou inacessível</small>
            </div>
          `}
        </div>
      `).join('');
    }

    // Update Ollama queues
    const ollamaContainer = document.getElementById('ollamaQueuesContainer');
    if (data.ollama.queues.length === 0) {
      ollamaContainer.innerHTML = '<div class="text-center text-muted py-3">Nenhum endpoint Ollama configurado</div>';
    } else {
      ollamaContainer.innerHTML = data.ollama.queues.map(queue => `
        <div class="queue-item p-2 mb-2 border rounded ${queue.healthy ? 'border-success bg-light' : 'border-danger bg-light'}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${queue.url}</strong>
              <span class="badge ${queue.type === 'RKLLama' ? 'bg-info' : 'bg-primary'} ms-1">${queue.type}</span>
              <span class="badge ${queue.healthy ? 'bg-success' : 'bg-danger'} ms-1">
                ${queue.healthy ? 'Online' : 'Offline'}
              </span>
            </div>
            <div class="text-end">
              <div><small class="text-muted">Ativo:</small> <span class="badge bg-warning">${queue.activeRequests}</span></div>
              <div><small class="text-muted">Total:</small> <span class="badge bg-secondary">${queue.totalRequests}</span></div>
            </div>
          </div>
          ${queue.healthy ? `
            <div class="mt-2">
              <small class="text-muted">
                Modelos: ${queue.runningModels} | 
                Score: ${queue.loadScore}
                ${queue.currentModel ? ` | Atual: ${queue.currentModel}` : ''}
              </small>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

  } catch (error) {
    console.error('Erro ao atualizar filas de processamento:', error);
    document.getElementById('whisperQueuesContainer').innerHTML = 
      '<div class="alert alert-warning">Erro ao carregar dados</div>';
    document.getElementById('ollamaQueuesContainer').innerHTML = 
      '<div class="alert alert-warning">Erro ao carregar dados</div>';
  }
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  initCharts();
  updateSystemStats();
  updateProcessingQueues();
  
  // Update every 5 seconds
  setInterval(() => {
    updateSystemStats();
    updateProcessingQueues();
  }, 5000);
});
</script>

<style>
.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}

.progress {
  border-radius: 10px;
}

.progress-bar {
  border-radius: 10px;
}

#cpuChart, #memoryChart {
  max-width: 120px;
  max-height: 120px;
}

/* Melhor alinhamento para os percentuais nos gráficos circulares */
.chart-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto;
}

.chart-center-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  pointer-events: none;
}

.chart-center-text h3 {
  font-size: 1.8rem;
  font-weight: 700;
  line-height: 1;
  margin: 0;
  color: #2c3e50;
}

.chart-center-text small {
  font-size: 0.75rem;
  line-height: 1;
  margin-top: 2px;
  color: #6c757d;
}

/* Força o alinhamento central mesmo com diferentes tamanhos de número */
#cpuUsage, #memoryUsage {
  min-width: 2ch;
  text-align: center;
}

.processing-queues {
  max-height: 300px;
  overflow-y: auto;
}

.queue-item {
  transition: all 0.2s ease;
}

.queue-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.processing-queues::-webkit-scrollbar {
  width: 6px;
}

.processing-queues::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.processing-queues::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.processing-queues::-webkit-scrollbar-thumb:hover {
  background: #555;
}
</style>
