<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fab fa-linkedin me-2"></i>Análise de Perfil do LinkedIn</h3>
        </div>
        <div class="card-body">
            <!-- Credential Status -->
            <div id="credentialStatus" class="alert <%= locals.credentialStatus?.hasCredentials ? 'alert-success' : 'alert-warning' %>" role="alert">
                <h5 class="alert-heading"><%= locals.credentialStatus?.status || 'Status Indisponível' %></h5>
                <p><%= locals.credentialStatus?.message || 'Não foi possível verificar as credenciais.' %></p>
                <% if (!locals.credentialStatus?.hasCredentials) { %>
                    <hr>
                    <a href="/config" class="btn btn-sm btn-outline-primary mt-2">Ir para Configurações</a>
                <% } %>
            </div>

            <!-- Formulário de Análise -->
            <form action="/linkedin/analyze" method="POST" class="mb-4">
                <div class="mb-3">
                    <label for="url" class="form-label"><strong>URL do Perfil do LinkedIn:</strong></label>
                    <input type="url" id="url" name="url" class="form-control" placeholder="https://www.linkedin.com/in/..." required value="<%= locals.url || '' %>">
                </div>
                <div class="mb-3">
                    <label for="analysisType" class="form-label"><strong>Tipo de Análise:</strong></label>
                    <select id="analysisType" name="analysisType" class="form-select">
                        <option value="structured" <%= (locals.analysisType === 'structured' || !locals.analysisType) ? 'selected' : '' %>>Estruturada (Completa)</option>
                        <option value="raw" <%= locals.analysisType === 'raw' ? 'selected' : '' %>>Apenas Texto Bruto</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Analisar Perfil
                </button>
            </form>

            <% if (locals.error) { %>
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading">Erro na Análise</h5>
                <p><%= locals.error %></p>
            </div>
            <% } %>

            <% if (requestNewLogin) { %>
              <div class="card mt-4 border-warning">
                  <div class="card-header bg-warning text-dark">
                      <strong><i class="fas fa-key"></i> Sessão Expirada ou Inválida</strong>
                  </div>
                  <div class="card-body">
                      <p>Sua sessão do LinkedIn expirou ou é inválida. Por favor, faça o login novamente para continuar.</p>
                      <form action="/linkedin/re-login-and-analyze" method="POST">
                          <!-- Hidden fields to retain original request data -->
                          <input type="hidden" name="url" value="<%= locals.url || '' %>">
                          <input type="hidden" name="analysisType" value="<%= locals.analysisType || '' %>">
                          
                          <div class="mb-3">
                              <label for="linkedinEmail" class="form-label">Email do LinkedIn</label>
                              <input type="email" class="form-control" id="linkedinEmail" name="linkedinEmail" required>
                          </div>
                          <div class="mb-3">
                              <label for="linkedinPassword" class="form-label">Senha do LinkedIn</label>
                              <input type="password" class="form-control" id="linkedinPassword" name="linkedinPassword" required>
                          </div>
                          <button type="submit" class="btn btn-primary w-100">
                              <i class="fas fa-sign-in-alt"></i> Login e Analisar
                          </button>
                      </form>
                  </div>
              </div>
            <% } %>

            <!-- Resultados da Análise -->
            <% if (locals.analysis && locals.analysis.data) { %>
                <% const data = locals.analysis.data; %>
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Resultados da Análise para: <%= data.name || 'Perfil' %></h4>
                    </div>
                    <div class="card-body">
                        <!-- Profile Header -->
                        <div class="row align-items-center mb-4">
                            <div class="col-md-2 text-center">
                                <% if (data.profilePictureUrl) { %>
                                    <img src="<%= data.profilePictureUrl %>" alt="Foto do Perfil" class="img-fluid rounded-circle shadow-sm" style="width: 120px; height: 120px; object-fit: cover;">
                                <% } else { %>
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 120px; height: 120px;">
                                        <span>Sem Foto</span>
                                    </div>
                                <% } %>
                            </div>
                            <div class="col-md-10">
                                <h3><%= data.name || 'Nome não encontrado' %></h3>
                                <p class="lead text-muted"><%= data.headline || 'Título não encontrado' %></p>
                                <p><i class="fas fa-map-marker-alt me-2 text-secondary"></i><%= data.location || 'Localização não encontrada' %></p>
                                <p><i class="fas fa-users me-2 text-secondary"></i><%= data.connections || 'Conexões não encontradas' %></p>
                            </div>
                        </div>

                        <!-- Data Quality -->
                        <% if (locals.analysis.dataQuality) { %>
                        <div class="mb-4">
                            <strong>Qualidade dos Dados: <%= locals.analysis.dataQuality.percentage %>%</strong>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: <%= locals.analysis.dataQuality.percentage %>%;" aria-valuenow="<%= locals.analysis.dataQuality.percentage %>" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <% } %>

                        <!-- Accordion for Details -->
                        <div class="accordion" id="linkedinAccordion">
                            <% if (data.about) { %>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingAbout">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAbout" aria-expanded="true" aria-controls="collapseAbout">
                                        <strong><i class="fas fa-user-circle me-2"></i>Sobre</strong>
                                    </button>
                                </h2>
                                <div id="collapseAbout" class="accordion-collapse collapse show" aria-labelledby="headingAbout">
                                    <div class="accordion-body">
                                        <p style="white-space: pre-wrap;"><%= data.about %></p>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (data.experience && data.experience.length > 0) { %>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingExperience">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExperience" aria-expanded="false" aria-controls="collapseExperience">
                                        <strong><i class="fas fa-briefcase me-2"></i>Experiência Profissional</strong>
                                    </button>
                                </h2>
                                <div id="collapseExperience" class="accordion-collapse collapse" aria-labelledby="headingExperience">
                                    <div class="accordion-body">
                                        <% data.experience.forEach(exp => { %>
                                            <div class="mb-3 border-bottom pb-3">
                                                <h5><%= exp.title %></h5>
                                                <p class="mb-1"><strong><%= exp.company %></strong></p>
                                                <p class="text-muted small"><%= exp.duration %></p>
                                                <p><%= exp.description %></p>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (data.education && data.education.length > 0) { %>
                             <div class="accordion-item">
                                <h2 class="accordion-header" id="headingEducation">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEducation" aria-expanded="false" aria-controls="collapseEducation">
                                        <strong><i class="fas fa-graduation-cap me-2"></i>Educação</strong>
                                    </button>
                                </h2>
                                <div id="collapseEducation" class="accordion-collapse collapse" aria-labelledby="headingEducation">
                                    <div class="accordion-body">
                                        <% data.education.forEach(edu => { %>
                                            <div class="mb-3 border-bottom pb-3">
                                                <h5><%= edu.degree %></h5>
                                                <p class="mb-1"><%= edu.school %></p>
                                                <p class="text-muted small"><%= edu.years %></p>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                            <% if (data.skills && data.skills.length > 0) { %>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSkills">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSkills" aria-expanded="false" aria-controls="collapseSkills">
                                        <strong><i class="fas fa-cogs me-2"></i>Habilidades</strong>
                                    </button>
                                </h2>
                                <div id="collapseSkills" class="accordion-collapse collapse" aria-labelledby="headingSkills">
                                    <div class="accordion-body">
                                        <% data.skills.forEach(skill => { %>
                                            <span class="badge bg-info text-dark me-2 mb-2"><%= skill %></span>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                            <!-- Outras Seções -->
                             <% const otherSections = [
                                { title: 'Certificações', data: data.certifications, icon: 'fa-certificate', key: 'cert' },
                                { title: 'Publicações', data: data.publications, icon: 'fa-book-open', key: 'pub' },
                                { title: 'Honras e Prêmios', data: data.honors, icon: 'fa-trophy', key: 'honor' },
                                { title: 'Idiomas', data: data.languages, icon: 'fa-language', key: 'lang' },
                                { title: 'Voluntariado', data: data.volunteering, icon: 'fa-hands-helping', key: 'vol' }
                            ]; %>

                            <% otherSections.forEach((section, index) => { %>
                                <% if (section.data && section.data.length > 0) { %>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading<%= section.key %>">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= section.key %>" aria-expanded="false" aria-controls="collapse<%= section.key %>">
                                            <strong><i class="fas <%= section.icon %> me-2"></i><%= section.title %></strong>
                                        </button>
                                    </h2>
                                    <div id="collapse<%= section.key %>" class="accordion-collapse collapse" aria-labelledby="heading<%= section.key %>">
                                        <div class="accordion-body">
                                            <% section.data.forEach(item => { %>
                                                <div class="mb-3 border-bottom pb-3">
                                                    <% if (section.key === 'cert') { %>
                                                        <h5><%= item.name %></h5>
                                                        <p><%= item.issuer %> - <%= item.issuedDate %></p>
                                                    <% } else if (section.key === 'pub') { %>
                                                        <h5><%= item.title %></h5>
                                                        <p><%= item.publisher %> - <%= item.date %></p>
                                                    <% } else if (section.key === 'honor') { %>
                                                        <h5><%= item.title %></h5>
                                                        <p><%= item.issuer %> - <%= item.date %></p>
                                                    <% } else if (section.key === 'lang') { %>
                                                        <h5><%= item.language %></h5>
                                                        <p><%= item.proficiency %></p>
                                                    <% } else if (section.key === 'vol') { %>
                                                        <h5><%= item.role %></h5>
                                                        <p><%= item.organization %> - <%= item.duration %></p>
                                                    <% } %>
                                                </div>
                                            <% }); %>
                                        </div>
                                    </div>
                                </div>
                                <% } %>
                            <% }); %>

                            <!-- Raw Text -->
                             <div class="accordion-item">
                                <h2 class="accordion-header" id="headingRawText">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRawText" aria-expanded="false" aria-controls="collapseRawText">
                                        <strong><i class="fas fa-file-alt me-2"></i>Texto Bruto Extraído</strong>
                                    </button>
                                </h2>
                                <div id="collapseRawText" class="accordion-collapse collapse" aria-labelledby="headingRawText">
                                    <div class="accordion-body">
                                        <textarea class="form-control" rows="15" readonly><%= locals.analysis.rawText || 'Nenhum texto bruto foi extraído.' %></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

